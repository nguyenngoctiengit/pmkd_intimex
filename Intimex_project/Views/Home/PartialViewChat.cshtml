
@{
    ViewData["Title"] = "chat";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<!--EmojiOneArea -->
<!--css chat -->
<link href="~/css/ChatPartialView.css" rel="stylesheet" />
<script src="~/js/notify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.min.js" integrity="sha512-hkvXFLlESjeYENO4CNi69z3A1puvONQV5Uh+G4TUDayZxSLyic5Kba9hhuiNLbHqdnKNMk2PxXKm0v7KDnWkYA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.min.css" integrity="sha512-vEia6TQGr3FqC6h55/NdU3QSM5XR6HSl5fW71QTKrgeER98LIMGwymBVM867C1XHIkYD9nMTfWK2A0xcodKHNA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
    .buttonChat {
        text-align: left;
    }

    .text-center {
        text-align: center;
    }

    .emojionearea-button {
        margin-top: 50px;
    }

    .btn {
        background-color: #494e52; /* Blue background */
        border: none; /* Remove borders */
        color: white; /* White text */
        padding: 12px 16px; /* Some padding */
        font-size: 16px; /* Set a font size */
        cursor: pointer; /* Mouse pointer on hover */
    }
</style>
<script>
    $(function () {
        $("#messageInput1").emojioneArea();
    });
</script>
<div class="right_col" role="main" style="height: 100%">
    <h3 class="text-center">Messing to @ViewBag.messingTo</h3>
    <div class="messaging">
        <div class="inbox_msg">
            <div class="inbox_people">
                <div class="headind_srch">
                    <div class="srch_bar">
                        <div class="stylish-input-group">
                            <input type="text" class="search-bar" placeholder="Search" id="keySearch" onkeyup="Search()">
                        </div>
                    </div>
                </div>
                <div class="inbox_chat scroll">
                    @{ foreach (var item in ViewBag.user)
                        {
                            <button class="buttonChat" onclick="location.href='@item.Id'" value="@item.NormalizedUserName" style="padding:0;border:none;background:none" type="submit">
                                <div class="chat_list">
                                    <div class="chat_people">

                                        <div class="chat_img"> <img src="~/Images/@item.Image" /> </div>
                                        <div class="chat_ib">
                                            <h5 id="h5">
                                                @item.NormalizedUserName
                                                @{
                                                    if (item.Online == true)
                                                    {
                                                        <span class="chat_date">Online</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="chat_date">Offline</span>
                                                    }
                                                }
                                            </h5>

                                        </div>
                                    </div>
                                </div>
                            </button>
                        }
                    }
                </div>
            </div>
            <input type="text" id="senderInput" value="@ViewBag.sender" hidden />
            <input type="text" id="receiverInput" value="@ViewBag.receiver" hidden />
            <div class="mesgs">
                <div class="headind_srch">
                    <div class="srch_bar">
                        <div class="stylish-input-group">
                            <input type="text" class="search-bar" placeholder="Search" id="keySearchMessage" onkeyup="SearchMessage()">
                        </div>
                    </div>
                </div>
                <div class="msg_history" id="msg_history">
                    <script type="text/javascript">
                        function scrollChat() {
                            var msg_history = document.getElementById("msg_history");
                            msg_history.scrollTop = msg_history.scrollHeight;
                            document.getElementById('messageInput1').focus();

                        }
                        window.addEventListener('load', scrollChat);

                    </script>
                    <div class=""></div>
                    @{ foreach (var item in ViewBag.outMsg)
                        {
                            if (item.FromUser == ViewBag.sender && item.ToUser == ViewBag.receiver)
                            {
                                <div class="outgoing_msg">
                                    <div class="sent_msg" id="sent_msg">
                                        <p onclick="DownloadDocument('@item.Message1')" style="cursor:pointer">
                                            @item.Message1
                                        </p>
                                        <span class="time_date"> @item.Date</span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="incoming_msg">
                                    <div class="incoming_msg_img">
                                        <img src="~/Images/Avatar.PNG" />
                                    </div>
                                    <div class="received_msg">
                                        <div class="received_withd_msg">
                                            <p onclick="DownloadDocument('@item.Message1')" style="cursor:pointer">@item.Message1</p>
                                            <span class="time_date"> @item.Date</span>
                                        </div>
                                    </div>
                                </div> }

                        } }
                    <div id="createDiv_incoming_msg"></div>
                    <div id="createDiv_outgoing_msg"></div>
                </div>
                <div>
                    <input type="file" name="file" id="fileUpload" onchange="UploadFile(event)">
                </div>
                <div class="type_msg">
                    <div class="input_msg_write">
                        <textarea type="text" class="write_msg" id="messageInput1" placeholder="Type a message"></textarea>
                        <button class="msg_send_btn" type="button" id="sendButton1"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- signalr -->
<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
<script src="~/js/chat1.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript">
    document.getElementById('messageInput1').addEventListener('keyup', function (event) {
        event.preventDefault();
        if (event.keyCode === 13) {
            document.getElementById('sendButton1').click();
        }
    });

    function DownloadDocument(id) {
        var extensionFile = ["docx", "jpg", "jpeg", "gif", "png", "doc", "pdf", "xls",
            "xlsx", "xlsm", "pptx", "pptm", "ppt", "txt", "mp3", "mp4", "rar", "zip"];
        var regex = new RegExp("([a-zA-Z0-9\s_\\.\-:])+(" + extensionFile.join('|') + ")$");
        if (!regex.test(id.toLowerCase())) {
            $.notify("This is not a file. Cannot download !!", "error");
        } else {
            location.href = '/home/DownloadDocument/' + id;
        }
    }

    function Search() {
        var searchKey = document.getElementById('keySearch');
        var filter = searchKey.value.toUpperCase();
        var button = document.querySelectorAll('.buttonChat');
        for (var i of button) {
            var item = i.value;
            if (item.toUpperCase().indexOf(filter) > -1) {
                i.style.display = '';
            } else {
                i.style.display = 'none';
            }
        }
    }
    function SearchMessage() {
        var searchKey = document.getElementById('keySearchMessage');
        var filter = searchKey.value.toUpperCase();
        var count = 0;
        $('#msg_history div').each(function () {
            if ($(this).text().search(new RegExp(filter, "i")) < 0) {
                $(this).hide();  // MY CHANGE

                // Show the list item if the phrase matches and increase the count by 1
            } else {
                $(this).show(); // MY CHANGE
                count++;
            }
        })
    }
    $('.msg_history').scroll(function () {
        if ($('.msg_history').scrollTop() == 0) {
            if (GetDataMessage() != 0) {
                GetDataMessage();
                $('.msg_history').scrollTop(30);
            }
        }
    });
    var pageSize = 10;
    var pageIndex = 1;
    var id = document.getElementById('receiverInput').value;
    var sender = document.getElementById('senderInput').value;
    var receiver = document.getElementById('receiverInput').value;
    function GetDataMessage() {
        $.ajax({
            type: 'GET',
            url: '/home/GetDataMessage',
            data: { "pageindex": pageIndex, "pagesize": pageSize, "id": id },
            dataType: 'json',
            success: function (data) {
                if (data != null) {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].FromUser == sender && data[i].ToUser == receiver) {
                            $('#msg_history').prepend(' <div class="outgoing_msg">' +
                                '<div class="sent_msg">' +
                                '<p onclick="DownloadDocument(\'' + data[i].Message1 + '\')" style="cursor: pointer">'
                                + data[i].Message1 +
                                '</p>' +
                                '<span class="time_date">' + data[i].Date + '</span>' +
                                '</div>' +
                                '</div>');

                        } else {
                            $('#msg_history').prepend('<div class="incoming_msg">' +
                                '<div class="incoming_msg_img">' +
                                '<img src="/Images/Avatar.PNG" />' +
                                ' </div>' +
                                '<div class="received_msg">' +
                                '<div class="received_withd_msg">' +
                                '<p onclick="DownloadDocument(\'' + data[i].Message1 + '\')" style="cursor: pointer">' + data[i].Message1 + '</p>' +
                                '<span class="time_date">' + data[i].Date + '</span>' +
                                '</div>' +
                                '</div>' +
                                '</div>');
                        }
                    }

                }

            },
            error: function () {
                alert('Đã load hết dữ liệu chat !!');
            }
        })
        pageIndex++;
    }
</script>
