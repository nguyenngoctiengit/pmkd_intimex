
@{
    ViewData["Title"] = "chat";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>*@
<link href="~/css/chat1.css" rel="stylesheet" />
<style>
    .buttonChat {
        text-align: left;
    }

    .text-center {
        text-align: center;
    }

    .btn {
        background-color: #494e52; /* Blue background */
        border: none; /* Remove borders */
        color: white; /* White text */
        padding: 12px 16px; /* Some padding */
        font-size: 16px; /* Set a font size */
        cursor: pointer; /* Mouse pointer on hover */
    }
</style>
<div class="right_col" role="main" style="height: 100%">
    <h3 class="text-center">Messing to @ViewBag.messingTo</h3>
    <div class="messaging">
        <div class="inbox_msg">
            <div class="inbox_people">
                <div class="headind_srch">
                    <div class="srch_bar">
                        <div class="stylish-input-group">
                            <input type="text" class="search-bar" placeholder="Search" id="keySearch" onkeyup="Search()">
                        </div>
                    </div>
                </div>
                <div class="inbox_chat scroll">
                    @{ foreach (var item in ViewBag.user)
                        {
                            <button class="buttonChat" onclick="location.href='@item.Id'" value="@item.NormalizedUserName" style="padding:0;border:none;background:none" type="submit">
                                <div class="chat_list">
                                    <div class="chat_people">

                                        <div class="chat_img"> <img src="~/Images/@item.Image" /> </div>
                                        <div class="chat_ib">
                                            <h5 id="h5">
                                                @item.NormalizedUserName
                                                @{
                                                    if (item.Online == true)
                                                    {
                                                        <span class="chat_date">Online</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="chat_date">Offline</span>
                                                    }
                                                }
                                            </h5>

                                        </div>
                                    </div>
                                </div>
                            </button>
                        }
                    }
                </div>
            </div>
            <input type="text" id="senderInput" value="@ViewBag.sender" hidden />
            <input type="text" id="receiverInput" value="@ViewBag.receiver" hidden />
            <div class="mesgs">
                <div class="msg_history" id="msg_history">
                    <script type="text/javascript">
                        function scrollChat() {
                            var msg_history = document.getElementById("msg_history");
                            msg_history.scrollTop = msg_history.scrollHeight;
                            document.getElementById('messageInput').focus();
                        }
                        window.addEventListener('load', scrollChat);

                    </script>
                    <div class=""></div>
                    @{ foreach (var item in ViewBag.outMsg)
                        {
                            if (item.FromUser == ViewBag.sender && item.ToUser == ViewBag.receiver)
                            {
                                <div class="outgoing_msg">
                                    <div class="sent_msg">
                                        <p>
                                            @item.Message1
                                        </p>
                                        <span class="time_date"> @item.Date</span>
                                    </div>
                                </div> }
                            else
                            {
                                <div class="incoming_msg">
                                    <div class="incoming_msg_img">
                                        <img src="~/Images/Avatar.PNG" />
                                    </div>
                                    <div class="received_msg">
                                        <div class="received_withd_msg">
                                            <p>@item.Message1</p>
                                            <span class="time_date"> @item.Date</span>
                                        </div>
                                    </div>
                                </div> }

                        } }
                </div>
                <div class="type_msg">
                    <div class="input_msg_write">
                        <input type="text" class="write_msg" id="messageInput" placeholder="Type a message" />
                        <button class="msg_send_btn" type="button" id="sendButton"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
<script src="~/js/chat1.js"></script>
<script type="text/javascript">
    document.getElementById('messageInput').addEventListener('keyup', function (event) {
        event.preventDefault();
        if (event.keyCode === 13) {
            document.getElementById('sendButton').click();
        }
    });
    function Search() {
        var searchKey = document.getElementById('keySearch');
        var filter = searchKey.value.toUpperCase();
        var button = document.querySelectorAll('.buttonChat');
        for (var i of button) {
            var item = i.value;
            if (item.toUpperCase().indexOf(filter) > -1) {
                i.style.display = '';
            } else {
                i.style.display = 'none';
            }
        }
    }
    $('.msg_history').scroll(function () {
        if ($('.msg_history').scrollTop() == $(document).height() - $(window).height()) {
            GetDataMessage();
        }
    });
    var pageSize = 10;
    var pageIndex = 2;
    var id = document.getElementById('receiverInput').value;
    var sender = document.getElementById('senderInput').value;
    var receiver = document.getElementById('receiverInput').value;
    function GetDataMessage() {
        $.ajax({
            type: 'GET',
            url: '/home/GetDataMessage',
            data: { "pageindex": pageIndex, "pagesize": pageSize, "id": id },
            dataType: 'json',
            success: function (data) {
                if (data != null) {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].FromUser == sender && data[i].ToUser == receiver) {
                            $('#msg_history').prepend(' <div class="outgoing_msg">' +
                                '<div class="sent_msg">' +
                                '<p>'
                                + data[i].Message1 +
                                '</p>' +
                                '<span class="time_date">' + data[i].Date + '</span>' +
                                '</div>' +
                                '</div>');

                        } else {
                            $('#msg_history').prepend('<div class="incoming_msg">' +
                                '<div class="incoming_msg_img">' +
                                ' </div>' +
                                '<div class="received_msg">' +
                                '<div class="received_withd_msg">' +
                                '<p>' + data[i].Message1 + '</p>' +
                                '<span class="time_date">' + data[i].Date + '</span>' +
                                '</div>' +
                                '</div>' +
                                '</div>');
                        }
                    }
                }
                pageIndex++;
            },
        })
    }
</script>
